mainhost = "https://polytron-psikotest.co.id";

//FUNGSI CEGAH PRINT SCREEN END
function setpassword(event) {
    event.preventDefault();
    var token = $("meta[name='csrf-token']").attr("content");
    var isdisabled = 'enabled';
    if (isdisabled == 'disabled') {
        alert('Mohon izinkan kamera untuk melanjutkan');
        return false; // Do something else in here if required
    } else {
        var aktivasi = $('#kode_aktivasi').val();
        var password = $('#password').val();
        var konfirmasi_password = $('#konfirmasi_password').val();
        if (aktivasi == "") {
            alert("Masukkan Kode tes Anda");
            return false;
        }
        if (password == "") {
            alert("Masukkan password Kode tes Anda");
            return false;
        }
        if (password != konfirmasi_password) {
            alert("Password tidak sesuai");
            return false;
        }

        $.ajax({
            type: "POST",
            dataType: "json",
            cache: false,
            data: {
                "password": password,
                "aktivasi": aktivasi,
                "_token": token
            },
            url: mainhost + "/m/cekdata",
            success: function(data) {
                if (data == "kosong") {
                    alert("Kode aktivasi tidak terdaftar");
                } else {
                    var json = data;
                    $("#isi").html(json.html);
                    $("#href").val(json.href);
                    $("#kode_aktivasi_place").val(json.kode_aktivasi);
                    if (json.cam == "1") {
                        $("#capture-btn").html("Tunggu..");
                        getPhoto();
                        //setTimeout(function(){ $("#capture-btn").html("Mulai"); }, 3000);
                    } else {
                        startWithoutPhoto();
                    }
                    if (json.geo == "1") {
                        getLocation();
                    }
                }
            }
        });
    }
};

function cekpassword(event) {
    event.preventDefault();
    var token = $("meta[name='csrf-token']").attr("content");
    var isdisabled = 'enabled';
    if (isdisabled == 'disabled') {
        alert('Mohon izinkan kamera untuk melanjutkan');
        return false; // Do something else in here if required
    } else {
        var aktivasi = $('#kode_aktivasi').val();
        var password = $('#password').val();
        if (aktivasi == "") {
            alert("Masukkan Kode tes Anda");
            return false;
        }
        if (password == "") {
            alert("Masukkan password Kode tes Anda");
            return false;
        }
        $.ajax({
            type: "POST",
            dataType: "json",
            cache: false,
            data: {
                "password": password,
                "aktivasi": aktivasi,
                "_token": token
            },
            url: mainhost + "/m/cekdata",
            success: function(data) {
                if (data == "kosong") {
                    alert("Kode aktivasi tidak terdaftar");
                } else {
                    var json = data;
                    $("#isi").html(json.html);
                    $("#href").val(json.href);
                    $("#kode_aktivasi_place").val(json.kode_aktivasi);
                    if (json.cam == "1") {
                        $("#capture-btn").html("Tunggu..");
                        getPhoto();
                        //setTimeout(function(){ $("#capture-btn").html("Mulai"); }, 3000);
                    } else {
                        startWithoutPhoto();
                    }
                    if (json.geo == "1") {
                        getLocation();
                    }
                }
            }
        });
    }
};

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, GeoshowError);
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}

function startWithoutPhoto() {
    $("#capture-btn").attr("disabled", false);
    $('#isi').on('click', '#capture-btn', function() {
        window.location.href = $("#href").val();
    })
}

function getPhoto() {
    const videoPlayer = document.querySelector("#player");
    const aktivasi = document.querySelector("#kode_aktivasi_place");
    const latitude = document.querySelector("#latitude");
    const longitude = document.querySelector("#longitude");
    const canvasElement = document.querySelector("#canvas");
    const imagePicker = document.querySelector("#image-picker");
    const imagePickerArea = document.querySelector("#pick-image");
    const newImages = document.querySelector("#newImages");
    const captureButton = document.querySelector("#capture-btn");

    // Image dimensions
    const width = 320;
    const height = 240;
    let zIndex = 1;

    const createImage = (src, alt, title, width, height, className) => {
        let newImg = document.createElement("img");

        if (src !== null) newImg.setAttribute("src", src);
        if (alt !== null) newImg.setAttribute("alt", alt);
        if (title !== null) newImg.setAttribute("title", title);
        if (width !== null) newImg.setAttribute("width", width);
        if (height !== null) newImg.setAttribute("height", height);
        if (className !== null) newImg.setAttribute("class", className);

        return newImg;
    };

    const startMedia = () => {
        if (!("mediaDevices" in navigator)) {
            navigator.mediaDevices = {};
        }

        if (!("getUserMedia" in navigator.mediaDevices)) {
            navigator.mediaDevices.getUserMedia = constraints => {
                const getUserMedia =
                    navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

                if (!getUserMedia) {
                    return Promise.reject(new Error("getUserMedia is not supported"));
                } else {
                    return new Promise((resolve, reject) =>
                        getUserMedia.call(navigator, constraints, resolve, reject)
                    );
                }
            };
        }

        navigator.mediaDevices.getUserMedia({
                video: true
            })
            .then(stream => {
                videoPlayer.srcObject = stream;
                captureButton.removeAttribute("disabled");
                captureButton.innerHTML = 'Mulai';
                videoPlayer.style.display = "block";
            })
            .catch(err => {
                imagePickerArea.style.display = "block";
            });
    };

    // Capture the image, save it and then paste it to the DOM
    $('#isi').on('click', '#capture-btn', function() {
        // Draw the image from the video player on the canvas
        canvasElement.style.display = "block";
        const context = canvasElement.getContext("2d");
        context.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

        videoPlayer.srcObject.getVideoTracks().forEach(track => {
            // track.stop();
        });

        // Convert the data so it can be saved as a file
        let picture = canvasElement.toDataURL();

        // Save the file by posting it to the server
        fetch(mainhost + "/psi/m/camapp/api/save_image.php", {
                method: "post",
                body: JSON.stringify({
                    data: picture,
                    kodeaktivasi: aktivasi.value,
                    latitudex: latitude.value,
                    longitudex: longitude.value
                })
            })
            .then(
                function(response) {
                    window.location.href = $("#href").val();
                }
            )
            .catch(error => console.log(error));
    });
    startMedia();
}

function showPosition(position) {
    latitude.value = position.coords.latitude;
    longitude.value = position.coords.longitude;
}

function GeoshowError(error) {
    $("a[track='mulai']").attr('href', "#");
    $("a[track='mulai']").html('...');
    var a = "";
    switch (error.code) {
        case error.PERMISSION_DENIED:
            a = "User denied the request for Geolocation."
            break;
        case error.POSITION_UNAVAILABLE:
            a = "Location information is unavailable."
            break;
        case error.TIMEOUT:
            a = "The request to get user location timed out."
            break;
        case error.UNKNOWN_ERROR:
            a = "An unknown error occurred."
            break;
    }
    alert(a);
}

// fungsi ini akan dieksekusi jika  izin telah diberikan
function handleVideo(stream) {
    //video.srcObject = stream;
}

// fungsi ini akan dieksekusi kalau user menolak izin
function videoError(e) {
    // do something
    $("a[track='mulai']").attr('href', "#");
    $("a[track='mulai']").html('...');
    alert("Izinkan menggunakan webcam untuk mengambil gambar");
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

$(document).ready(function() {
    var x = document.getElementById("position");
    var latitude = document.getElementById("latitude");
    var longitude = document.getElementById("longitude");

    $(window).keydown(function(event) {
        if (event.keyCode == 13) {
            event.preventDefault();
            return false;
        }
    });

    $('#kode_aktivasi').focus();

    //var geo = 0;
    //var cam = 0;

    /*
		if(geo){
            getLocation();
        }
		*/

    // seleksi elemen video
    //var video = document.querySelector("#video-webcam");

    /*
		if(cam){
            // minta izin user
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;

            if (navigator.getUserMedia) {
                // jalankan fungsi handleVideo, dan videoError jika izin ditolak
                navigator.getUserMedia({ video: true }, handleVideo, videoError);
            }
        }
		*/

    //  $('#kode_aktivasi').keyboard();
    $(document).on("contextmenu", function(e) {
        if (e.target.nodeName != "INPUT" && e.target.nodeName != "TEXTAREA")
            e.preventDefault();
    });

    $("a[track='mulai']").click(function(e) {
        e.preventDefault();
        var token = $("meta[name='csrf-token']").attr("content");
        var data = [new ClipboardItem({
            "text/plain": new Blob(["Selamat Mengerjakan"], {
                type: "text/plain"
            })
        })];
        navigator.clipboard.readText().then(function() {
            //console.log("Copied to clipboard successfully!");
        }, function() {
            //console.error("Unable to write to clipboard. :-(");
            alert('Mohon izinkan clipboard untuk melanjutkan');
            return false; // Do something else in here if required
            //$("a[track='mulai']").attr('disabled', true);
        });

        var isdisabled = $(this).attr('disabled');
        if (isdisabled == 'disabled') {
            alert('Mohon izinkan kamera untuk melanjutkan');
            return false; // Do something else in here if required
        } else {
            var aktivasi = $('#kode_aktivasi').val();
            if (aktivasi == "") {
                alert("Masukkan Kode tes Anda");
                return false;
            }
            $.ajax({
                type: "POST",
                dataType: "json",
                cache: false,
                data: {
                    "aktivasi": aktivasi,
                    "_token": token
                },
                url: mainhost + "/m/cekdata",
                success: function(data) {
                    if (data == "kosong") {
                        alert("Kode aktivasi tidak terdaftar");
                    } else {
                        var json = data;
                        console.log(json);
                        $("#isi").html(json.html);
                        $("#href").val(json.href);
                        $("#kode_aktivasi_place").val(json.kode_aktivasi);
                        if (json.cam == "1") {
                            $("#capture-btn").html("Tunggu..");
                            getPhoto();
                            //setTimeout(function(){ $("#capture-btn").html("Mulai"); }, 3000);
                        } else {
                            startWithoutPhoto();
                        }
                        if (json.geo == "1") {
                            getLocation();
                        }
                    }
                },
            });
        }
    });
});
